From b690932a8043c979c8a3b22b37bef4c0502af07a Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?K=C3=A9vin=20L=27h=C3=B4pital?=
 <kevin.lhopital@savoirfairelinux.com>
Date: Fri, 2 Jul 2021 10:13:58 +0200
Subject: [PATCH] disable libx11 dependency

This dependency is irrelevant on i.MX6 platforms because we don't use X11.
Moreover compiling with libX11 requires to enable the disto feature X11
which will change the compilation of Qt5 and disable the EGLFS_VIV
plugin.
---
 CMakeLists.txt |  6 +-----
 avadapter.cpp  | 21 ---------------------
 2 files changed, 1 insertion(+), 26 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index c045f0c..cf037e4 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -211,11 +211,9 @@ if(MSVC)
                         ${QRENCODE})
 else()
     list(APPEND COMMON_SOURCES
-                ${SRC_DIR}/xrectsel.c
                 ${SRC_DIR}/dbuserrorhandler.cpp)
     list(APPEND COMMON_HEADERS
-                ${SRC_DIR}/dbuserrorhandler.h
-                ${SRC_DIR}/xrectsel.h)
+                ${SRC_DIR}/dbuserrorhandler.h)
     list(APPEND QML_LIBS Qt5::DBus)
     list(APPEND QML_LIBS_LIST DBus)
 
@@ -279,7 +277,6 @@ else()
 
     find_library(ringclient ringclient ${LRCLIBDIR} NO_DEFAULT_PATH)
     find_library(qrencode qrencode)
-    find_library(X11 X11)
 endif()
 
 # Qt find package
@@ -395,7 +392,6 @@ else()
                           ${QML_LIBS}
                           ${LRC_LIB_NAME}
                           ${qrencode}
-                          ${X11}
                           ${LIBNM_LIBRARIES}
                           ${LIBNOTIFY_LIBRARIES}
                           ${LIBGDKPIXBUF_LIBRARIES})
diff --git a/src/avadapter.cpp b/src/avadapter.cpp
index acb8644..b879173 100644
--- a/src/avadapter.cpp
+++ b/src/avadapter.cpp
@@ -21,10 +21,6 @@
 #include "avadapter.h"
 #include "qtutils.h"
 
-#ifdef Q_OS_LINUX
-#include "xrectsel.h"
-#endif
-
 #include <QtConcurrent/QtConcurrent>
 #include <QApplication>
 #include <QPainter>
@@ -190,29 +186,12 @@ AvAdapter::shareFile(const QString& filePath)
 void
 AvAdapter::shareScreenArea(unsigned x, unsigned y, unsigned width, unsigned height)
 {
-#ifdef Q_OS_LINUX
-    // xrectsel will freeze all displays too fast so that the call
-    // context menu will not be closed even closed signal is emitted
-    // use timer to wait until popup is closed
-    QTimer::singleShot(100, [=]() mutable {
-        x = y = width = height = 0;
-        xrectsel(&x, &y, &width, &height);
-
-        lrcInstance_->avModel().setDisplay(getScreenNumber(),
-                                           x,
-                                           y,
-                                           width < 128 ? 128 : width,
-                                           height < 128 ? 128 : height,
-                                           getCurrentCallId());
-    });
-#else
     lrcInstance_->avModel().setDisplay(getScreenNumber(),
                                        x,
                                        y,
                                        width < 128 ? 128 : width,
                                        height < 128 ? 128 : height,
                                        getCurrentCallId());
-#endif
 }
 
 void
-- 
2.17.1

